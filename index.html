<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>☬SHΞN™ imagine Pro </title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet" />

<style>
  :root {
      --purple-glow: #a855f7;
      --pink-glow: #ff6cf0;
      --dark-bg: #0A0A0A;
      --dark-card: #141414;
      --dark-border: #262626;
      --blue-electric: #00bfff;
      --primary-color: #a855f7;
      --secondary-color: #ff6cf0;
  }
  body {
      background-color: var(--dark-bg);
  }
  .font-brand { font-family: 'Orbitron', sans-serif; }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--dark-bg); }
  ::-webkit-scrollbar-thumb { background: var(--dark-border); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }

  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
  }
  .modal-fade-in { animation: fadeIn 0.2s ease-out forwards; }

  .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border: none;
  }

  .glass-border {
      border: 1px solid rgba(38, 38, 38, 0.5);
  }

  /* Smooth color transitions for the entire theme */
  @keyframes colorWave {
      0% { 
          --primary-color: #a855f7; 
          --secondary-color: #ff6cf0; 
      }
      25% { 
          --primary-color: #8b5cf6; 
          --secondary-color: #c084fc; 
      }
      50% { 
          --primary-color: #6366f1; 
          --secondary-color: #818cf8; 
      }
      75% { 
          --primary-color: #3b82f6; 
          --secondary-color: #60a5fa; 
      }
      100% { 
          --primary-color: #a855f7; 
          --secondary-color: #ff6cf0; 
      }
  }

  :root {
      animation: colorWave 12s ease-in-out infinite;
  }

  /* Apply dynamic colors to elements */
  .arched-header {
      border-color: rgba(168, 85, 247, 0.3);
  }

  .arched-header::after {
      background: radial-gradient(ellipse at 50% 150%, rgba(168, 85, 247, 0.35) 0%, rgba(168, 85, 247, 0) 70%);
      filter: blur(15px);
      transition: all 0.5s ease;
  }

  .prompt-box:focus-within {
      box-shadow:
          inset 0 2px 4px rgba(255, 255, 255, 0.08),
          0 6px 20px rgba(168, 85, 247, 0.2),
          0 0 25px rgba(168, 85, 247, 0.15);
  }

  .generate-btn {
      position: relative;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.08) !important;
      backdrop-filter: blur(10px);
      box-shadow:
          0 4px 15px rgba(168, 85, 247, 0.2),
          0 0 20px rgba(168, 85, 247, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
  }

  .generate-btn:hover {
      background: rgba(255, 255, 255, 0.12) !important;
      box-shadow:
          0 6px 25px rgba(168, 85, 247, 0.3),
          0 0 35px rgba(168, 85, 247, 0.2),
          inset 0 2px 0 rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
  }

  /* Arched Header Style */
  .header-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
  }
  .arched-header {
      width: 95%;
      max-width: 400px;
      height: 64px;
      border-top-left-radius: 50% 20px;
      border-top-right-radius: 50% 20px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .header-glow {
      position: relative;
      overflow: hidden;
  }
  .header-glow::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: sweep 4s ease-in-out infinite;
  }
  @keyframes sweep {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: -100%; }
  }

  .generate-btn::before {
      content: '';
      position: absolute;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      animation: sweep-reverse 4s ease-in-out infinite;
  }
  @keyframes sweep-reverse {
      0% { right: -100%; }
      50% { right: 100%; }
      100% { right: -100%; }
  }

  @keyframes spin-y {
      from { transform: rotateY(0deg); }
      to { transform: rotateY(360deg); }
  }
  .logo-spin {
      animation: spin-y 8s linear infinite;
      transform-style: preserve-3d;
  }

  @keyframes gradient-glow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
  }
  #prompt::placeholder {
      color: #6B7280;
      background-image: linear-gradient(90deg, rgba(168, 85, 247, 0.2), rgba(255, 108, 240, 0.2), rgba(168, 85, 247, 0.2));
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      animation: gradient-glow 6s ease-in-out infinite;
  }

  .animated-text {
      background: linear-gradient(90deg, #a855f7, #ff6cf0, #a855f7);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradient-move 3s ease-in-out infinite;
  }
  @keyframes gradient-move {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
  }

  .divider-glow {
      position: relative;
      height: 2px;
      background: rgba(255, 255, 255, 0.1);
  }
  .divider-glow::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.5), transparent);
      transform: translateX(-50%);
      animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
  }

  .prompt-box-container {
      position: relative;
      width: 100%;
  }
  .prompt-box {
      box-shadow:
          inset 0 2px 4px rgba(255, 255, 255, 0.05),
          0 4px 12px rgba(0, 0, 0, 0.3),
          0 0 15px rgba(168, 85, 247, 0.1);
      border-radius: 12px;
      transition: box-shadow 0.3s ease;
      position: relative;
      padding-right: 3rem; /* Make space for mic button */
  }

  /* Mic button inside prompt box */
  .mic-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(145deg, rgba(168, 85, 247, 0.2), rgba(120, 60, 200, 0.1));
      border: 1px solid rgba(168, 85, 247, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s ease;
  }
  .mic-btn:hover {
      background: rgba(168, 85, 247, 0.3);
  }
  .mic-btn svg {
      width: 14px;
      height: 14px;
      stroke: #a855f7;
      transition: stroke 0.3s ease;
  }
  .mic-btn.recording svg {
      stroke: #e3342f;
  }
  .mic-btn.recording::after {
      content: '';
      position: absolute;
      width: 120%;
      height: 120%;
      border-radius: 50%;
      border: 1px solid rgba(227, 52, 47, 0.3);
      animation: pulse-red 1.5s infinite;
  }
  @keyframes pulse-red {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 52, 47, 0.4); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(227, 52, 47, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 52, 47, 0); }
  }

  .footer-gradient {
      background: linear-gradient(90deg, var(--purple-glow), var(--pink-glow));
      -webkit-background-clip: text;
      color: transparent;
  }

  .vertical-label {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%) rotate(-90deg);
      transform-origin: left top;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: bold;
      color: var(--blue-electric);
      opacity: 0.9;
      text-shadow: 0 0 8px rgba(0, 191, 255, 0.4);
      pointer-events: none;
      z-index: 10;
      white-space: nowrap;
  }
  .vertical-label a {
      color: inherit;
      text-decoration: none;
      transition: color 0.3s ease;
  }
  .vertical-label a:hover {
      color: #fff;
      text-shadow: 0 0 10px rgba(0, 191, 255, 0.8);
  }

  /* Vertical Line Style */
  .vertical-line {
      position: fixed;
      left: 50%;
      top: 104px; /* Position below the header buttons */
      width: 2px;
      height: 88px; /* Span the gap between header and main content */
      background: rgba(38, 38, 38, 0.5);
      transform: translateX(-50%);
      z-index: 15; /* Behind logo and main content, but above background */
  }

  /* Style Roller */
  #styleRoller {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
  }
  #styleRoller::-webkit-scrollbar {
      display: none; /* Chrome, Safari, and Opera */
  }
  .style-item {
      transition: all 0.2s ease-out;
      opacity: 0.5;
      transform: scale(0.9);
      cursor: pointer;
  }
  .style-item.is-active {
      opacity: 1;
      transform: scale(1);
      color: var(--purple-glow);
  }

  /* Chat-like image container - images appear above the prompt */
  .images-container {
      display: flex;
      flex-direction: column-reverse; /* This makes new images appear at the top */
      gap: 1rem;
      margin-bottom: 2rem; /* Space between images and prompt */
  }

  /* Image card animations */
  .image-card {
      animation: slideInFromTop 0.5s ease-out forwards;
      opacity: 0;
      transform: translateY(-20px);
  }
  
  @keyframes slideInFromTop {
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

</style>
</head>

<body class="text-gray-300 font-['Inter'] antialiased relative overflow-x-hidden">
<canvas id="bgCanvas" class="absolute inset-0 -z-10"></canvas>
<!-- The new vertical line -->
<div class="vertical-line"></div>

<!-- Header and Controls Container -->
<div class="header-container">
    <header class="arched-header glass glass-border border-t border-x border-purple-500/30 relative header-glow">
        <div class="font-brand text-2xl sm:text-3xl font-bold tracking-wider">
            <span class="animated-text">SHΞNΞRATOR</span>
        </div>
    </header>
    <div class="flex w-[95%] max-w-[400px] relative">
        <!-- دکمه Style (متن) -->
        <button id="styleBtn" class="w-1/2 h-10 text-sm font-medium text-purple-400 hover:text-white glass glass-border transition-colors relative flex items-center justify-center" style="border-bottom-left-radius: 50% 20px;">
            <span class="font-sans font-semibold tracking-wide">Style</span>
        </button>
        <!-- دکمه Settings (متن) -->
        <button id="settingsBtn" class="w-1/2 h-10 text-sm font-medium text-purple-400 hover:text-white glass glass-border transition-colors relative flex items-center justify-center" style="border-bottom-right-radius: 50% 20px;">
            <span class="font-sans font-semibold tracking-wide">Setup</span>
        </button>
        <!-- نور میانی -->
        <div class="divider-glow absolute" style="bottom: 0; left: 0; right: 0; height: 2px;"></div>
    </div>
    <!-- Logo Container with 3D perspective and spinning image - FIXED GLASS BACKGROUND -->
    <div class="absolute top-[70px] left-1/2 -translate-x-1/2" style="perspective: 1000px; z-index: 21;">
        <div class="rounded-full p-1">
            <img src="https://raw.githubusercontent.com/Shervinuri/Shervinuri.github.io/refs/heads/main/1712259501956.png" alt="Logo" class="w-12 h-12 rounded-full logo-spin" onerror="this.onerror=null;this.src='https://placehold.co/48x48/000000/ffffff?text=S';">
        </div>
    </div>
</div>

<!-- Main -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-48 pb-12" style="position: relative; z-index: 18;">
    
    <!-- Images Container - Chat-like layout above the prompt -->
    <div id="images" class="images-container"></div>

    <!-- Prompt and Generate Button -->
    <div class="flex flex-col sm:flex-row gap-3 relative">
        <!-- Container for prompt and mic button -->
        <div class="prompt-box-container">
            <textarea id="prompt" rows="4" class="w-full glass glass-border prompt-box rounded-xl p-4 text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--purple-glow)] resize-none" placeholder="Write or Say your vision...!"></textarea>
            <!-- Mic button is now inside the container -->
            <div id="micBtn" class="mic-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </div>
        </div>

        <button id="generateBtn" class="flex items-center justify-center gap-2 h-auto sm:h-full px-6 py-3 font-semibold text-white generate-btn transition-all shadow-lg disabled:opacity-50 disabled:cursor-wait relative" style="border-bottom-left-radius: 50% 20px; border-bottom-right-radius: 50% 20px;">
            <span>☬</span>
            <span>Generate</span>
        </button>
    </div>
</main>

<!-- Footer -->
<footer class="text-center py-8">
    <a href="https://t.me/shervini" target="_blank" rel="noopener" class="footer-gradient font-semibold text-sm">
        Exclusive ☬SHΞN™ Made
    </a>
</footer>

<!-- Style Modal -->
<div id="styleModal" class="fixed inset-0 bg-black/60 z-30 hidden items-center justify-center p-4">
    <div class="glass glass-border rounded-xl w-full max-w-xs p-6 modal-fade-in">
        <h3 class="text-xl font-semibold mb-4 text-center">Choose a Style</h3>

        <!-- Style Roller Container -->
        <div id="styleRollerContainer" class="h-56 relative flex items-center justify-center">
            <!-- Selection Indicator -->
            <div class="absolute inset-x-0 h-10 top-1/2 -translate-y-1/2 bg-white/5 rounded-lg ring-1 ring-purple-500 z-0"></div>
            <div id="styleRoller" class="w-full h-full overflow-y-scroll snap-y snap-mandatory">
                <!-- Items will be populated by JS -->
            </div>
        </div>

        <div class="text-center mt-6 flex gap-3">
            <button id="saveStyle" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors">Save</button>
            <button id="closeStyle" class="flex-1 px-4 py-2 glass glass-border text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors">Close</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black/60 z-30 hidden items-center justify-center p-4">
    <div class="glass glass-border rounded-xl w-full max-w-md p-6 modal-fade-in">
        <h3 class="text-xl font-semibold mb-6">API Settings</h3>
        <div class="space-y-5">
            <div class="flex items-center justify-between">
                <label for="model">Model</label>
                <select id="model" class="w-48 glass glass-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--purple-glow)]">
                    <option value="flux">SHΞN™ Beta</option>
                    <option value="turbo">SHΞN™ +18</option>
                    <option value="dall-e-3">SHΞN™ Alpha</option>
                    <option value="midjourney">SHΞN™ Julietta</option>
                    <option value="stable-diffusion">SHΞN™ Plasma</option>
                </select>
            </div>
            <div class="flex items-center justify-between">
                <label for="width">Width</label>
                <input id="width" type="number" value="1024" class="w-48 glass glass-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--purple-glow)]">
            </div>
            <div class="flex items-center justify-between">
                <label for="height">Height</label>
                <input id="height" type="number" value="1024" class="w-48 glass glass-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--purple-glow)]">
            </div>
            <div class="flex items-center justify-between">
                <label for="enhance">Enhance Prompt</label>
                <input id="enhance" type="checkbox" checked class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
            </div>
            <div class="flex items-center justify-between">
                <label for="translate">Auto Translate</label>
                <input id="translate" type="checkbox" checked class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
            </div>
            <div class="flex items-center justify-between">
                <label for="seed">Seed</label>
                <div class="flex items-center gap-3">
                    <input id="seed" type="number" value="42" class="w-28 glass glass-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--purple-glow)]">
                    <input id="randomSeed" type="checkbox" checked class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                    <span class="text-sm text-gray-400">Random</span>
                </div>
            </div>
        </div>
        <div class="text-right mt-8">
            <button id="saveSettings" class="px-5 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700">Save & Close</button>
        </div>
    </div>
</div>

<!-- Age Confirmation Modal -->
<div id="ageModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
    <div class="glass glass-border rounded-xl w-full max-w-md p-6 text-center">
        <h3 class="text-xl font-bold text-red-400 mb-4">🔞 18+ Content Warning</h3>
        <p class="text-gray-300 mb-6">By selecting "SHΞN™ +18", you acknowledge that the system may generate explicit, adult, or violent content.</p>
        <div class="flex gap-4 justify-center">
            <button id="ageConfirm" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">OK I'm over 18</button>
            <button id="ageCancel" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium">Return</button>
        </div>
    </div>
</div>

<!-- Three.js & GSAP -->
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<!-- Background Animation -->
<script>
try {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("bgCanvas"), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    const particlesCount = 2500;
    const positions = new Float32Array(particlesCount*3);
    for(let i=0;i<particlesCount*3;i++){ positions[i]=(Math.random()-0.5)*30; }
    const geometry=new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const material=new THREE.PointsMaterial({color:0xff6cf0,size:0.03,transparent:true,blending:THREE.AdditiveBlending});
    const particles=new THREE.Points(geometry,material);
    scene.add(particles);
    camera.position.z=8;
    function animate(){ requestAnimationFrame(animate); particles.rotation.y+=0.0008; particles.rotation.x+=0.0004; renderer.render(scene,camera); }
    animate();
    window.addEventListener("resize",()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
    gsap.from(".header-container",{y:-80,opacity:0,duration:1});
    gsap.from("main",{opacity:0,scale:0.95,duration:1,delay:0.3});
    gsap.from("footer",{y:80,opacity:0,duration:1,delay:0.5});
} catch (e) {
    console.error("Failed to initialize 3D background.", e);
    const bgCanvas = document.getElementById('bgCanvas');
    if(bgCanvas) bgCanvas.style.display = 'none';
}
</script>

<!-- Main Application Logic -->
<script>
    // --- تنظیمات اصلی ---
    const baseUrl = 'https://image.pollinations.ai';

    // Free translation service using MyMemory API
    async function translateText(text, targetLang = 'en') {
        try {
            // Skip translation if text is already in English or very short
            if (text.length < 3 || /^[a-zA-Z0-9\s.,!?-]+$/.test(text)) {
                return text;
            }

            const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=auto|${targetLang}`);
            const data = await response.json();
            
            if (data.responseStatus === 200 && data.responseData.translatedText) {
                return data.responseData.translatedText;
            }
            
            // Fallback to original text if translation fails
            return text;
        } catch (error) {
            console.error('Translation failed:', error);
            return text; // Return original text if translation fails
        }
    }

    // Improved style templates with better prompts for higher quality results
    const styleTemplates = {
        cinema: " cinematic composition, dramatic lighting, film grain, color grading, wide aspect ratio, professional cinematography",
        realistic: " photorealistic, natural lighting, high detail, authentic textures, lifelike quality, professional photography",
        photography: " professional photography, 85mm lens, shallow depth of field, bokeh, natural lighting, sharp focus, composition rule of thirds",
        fantasy: " fantasy art, magical atmosphere, ethereal lighting, vibrant mystical colors, enchanted environment, otherworldly beauty",
        anime: " anime art style, cel shading, vibrant colors, detailed character design, beautiful anime scenery, studio quality animation",
        artistic: " digital art, concept art, artistic illustration, creative composition, trending on artstation, masterpiece quality",
        portrait: " professional portrait photography, studio lighting, shallow depth of field, sharp focus on subject, elegant composition",
        landscape: " landscape photography, golden hour lighting, dramatic sky, natural beauty, wide angle composition, breathtaking scenery"
    };

    const styles = [
        { name: 'None', data: null },
        { name: 'Cinematic', data: 'cinema' },
        { name: 'Realistic', data: 'realistic' },
        
        { name: 'Photography', data: 'photography' },
        { name: 'Fantasy', data: 'fantasy' },
        { name: 'Anime', data: 'anime' },
        { name: 'Artistic', data: 'artistic' },
        { name: 'Portrait', data: 'portrait' },
        { name: 'Landscape', data: 'landscape' },
    ];

    // Enhanced prompt templates for local enhancement with better quality keywords
    const enhancementTemplates = {
        photography: [
            "professional photography", "high resolution", "sharp focus", "perfect lighting",
            "excellent composition", "depth of field", "natural colors"
        ],
        artistic: [
            "digital masterpiece", "concept art", "detailed illustration", "vibrant colors",
            "artistic excellence", "creative composition", "trending artwork"
        ],
        realistic: [
            "photorealistic quality", "natural lighting", "ultra detailed", "realistic textures",
            "authentic appearance", "lifelike rendering", "high fidelity"
        ],
        fantasy: [
            "fantasy masterpiece", "magical realism", "ethereal beauty", "mystical atmosphere",
            "enchanted quality", "otherworldly charm", "fantasy excellence"
        ],
        cinema: [
            "cinematic quality", "film-like", "dramatic composition", "professional cinematography",
            "movie-grade", "cinematic lighting", "epic scale"
        ],
        anime: [
            "anime masterpiece", "studio quality", "beautiful anime art", "detailed animation style",
            "vibrant anime colors", "professional anime", "high quality anime"
        ],
        portrait: [
            "professional portrait", "studio quality", "perfect lighting", "sharp focus",
            "elegant composition", "portrait excellence", "professional headshot"
        ],
        landscape: [
            "landscape masterpiece", "natural beauty", "scenic excellence", "breathtaking view",
            "perfect composition", "golden hour", "stunning scenery"
        ]
    };

    // --- DOM Elements ---
    const dom = {
        promptInput: document.getElementById('prompt'),
        generateBtn: document.getElementById('generateBtn'),
        imagesContainer: document.getElementById('images'),
        styleBtn: document.getElementById('styleBtn'),
        settingsBtn: document.getElementById('settingsBtn'),
        styleModal: document.getElementById('styleModal'),
        closeStyleBtn: document.getElementById('closeStyle'),
        saveStyleBtn: document.getElementById('saveStyle'),
        styleRoller: document.getElementById('styleRoller'),
        settingsModal: document.getElementById('settingsModal'),
        saveSettingsBtn: document.getElementById('saveSettings'),
        modelSelect: document.getElementById('model'),
        widthInput: document.getElementById('width'),
        heightInput: document.getElementById('height'),
        enhanceCheckbox: document.getElementById('enhance'),
        translateCheckbox: document.getElementById('translate'),
        seedInput: document.getElementById('seed'),
        randomSeedCheckbox: document.getElementById('randomSeed'),
        micBtn: document.getElementById('micBtn'),
        ageModal: document.getElementById('ageModal'),
        ageConfirm: document.getElementById('ageConfirm'),
        ageCancel: document.getElementById('ageCancel'),
    };

    // --- State Management ---
    let appState = {
        isGenerating: false,
        selectedStyle: 'realistic',
        imageCounter: 0,
        savedStyleSelection: 'realistic', // Track saved style selection
        tempStyleSelection: 'realistic' // Temporary selection while browsing
    };

    // --- Core Functions ---
    const toggleModal = (modalToShow) => {
        if (modalToShow && modalToShow.classList.contains('hidden')) {
            modalToShow.classList.remove('hidden');
            modalToShow.classList.add('flex');
        } else {
            dom.styleModal.classList.add('hidden');
            dom.settingsModal.classList.add('hidden');
            dom.ageModal.classList.add('hidden');
            dom.ageModal.classList.remove('flex');
        }
    };

    const saveSettings = () => {
        const settings = {
            model: dom.modelSelect.value,
            width: parseInt(dom.widthInput.value) || 1024,
            height: parseInt(dom.heightInput.value) || 1024,
            seed: parseInt(dom.seedInput.value) || 42,
            randomSeed: dom.randomSeedCheckbox.checked,
            enhance: dom.enhanceCheckbox.checked,
            translate: dom.translateCheckbox.checked,
            selectedStyle: appState.selectedStyle // Save selected style
        };
        localStorage.setItem('shenerator_3d_settings_final', JSON.stringify(settings));
    };

    const loadSettings = () => {
        try {
            const saved = JSON.parse(localStorage.getItem('shenerator_3d_settings_final'));
            if (saved) {
                dom.modelSelect.value = saved.model || 'flux';
                dom.widthInput.value = saved.width || 1024;
                dom.heightInput.value = saved.height || 1024;
                dom.seedInput.value = saved.seed || 42;
                dom.randomSeedCheckbox.checked = saved.randomSeed !== false;
                if (saved.enhance === false) {
                    dom.enhanceCheckbox.checked = false;
                } else {
                    dom.enhanceCheckbox.checked = true;
                }
                if (saved.translate === false) {
                    dom.translateCheckbox.checked = false;
                } else {
                    dom.translateCheckbox.checked = true;
                }
                // Load saved style selection
                if (saved.selectedStyle) {
                    appState.selectedStyle = saved.selectedStyle;
                    appState.savedStyleSelection = saved.selectedStyle;
                    appState.tempStyleSelection = saved.selectedStyle;
                }
            }
        } catch (e) { console.error("Could not load settings.", e); }
        dom.seedInput.disabled = dom.randomSeedCheckbox.checked;
    };

    // Local prompt enhancement function with better quality
    function enhancePromptLocally(userPrompt, style) {
        let enhanced = userPrompt.trim();
        
        // Add style-specific enhancements
        if (style && enhancementTemplates[style]) {
            const styleWords = enhancementTemplates[style];
            const randomWords = styleWords.sort(() => 0.5 - Math.random()).slice(0, 4);
            enhanced += ', ' + randomWords.join(', ');
        }
        
        // Add general quality improvements
        const qualityWords = ['masterpiece quality', 'highly detailed', 'professional grade', 'premium quality'];
        const randomQuality = qualityWords[Math.floor(Math.random() * qualityWords.length)];
        enhanced += ', ' + randomQuality;
        
        // Add technical terms for better results
        if (Math.random() > 0.4) {
            const techTerms = ['8k resolution', 'ultra sharp', 'perfect composition', 'studio lighting', 'award winning'];
            const randomTech = techTerms[Math.floor(Math.random() * techTerms.length)];
            enhanced += ', ' + randomTech;
        }
        
        return enhanced;
    }

    // Enhanced prompt function - DISABLED for turbo model
    async function enhancePrompt(userPrompt) {
        try {
            // Check if turbo model is selected - if so, skip enhancement
            if (dom.modelSelect.value === 'turbo') {
                console.log('Turbo model selected - skipping prompt enhancement for NSFW compatibility');
                return userPrompt;
            }
            
            // Use local enhancement for other models
            const enhanced = enhancePromptLocally(userPrompt, appState.selectedStyle);
            console.log('Enhanced prompt locally:', enhanced);
            return enhanced;
        } catch (error) {
            console.error('Error enhancing prompt:', error);
            return userPrompt;
        }
    }

    async function generateImage() {
        if (appState.isGenerating) return;
        let rawPrompt = dom.promptInput.value.trim();
        if (!rawPrompt) {
            showTemporaryMessage('Please enter a prompt');
            return;
        }

        appState.isGenerating = true;
        dom.generateBtn.disabled = true;

        // Create image card with animation
        const card = document.createElement('div');
        card.className = 'image-card relative glass glass-border rounded-lg aspect-square flex items-center justify-center';
        card.innerHTML = `<div class="flex flex-col items-center gap-2 text-gray-400"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div><span class="text-xs">Initializing...</span></div>`;
        
        // Add to top of images container (chat-like behavior)
        dom.imagesContainer.insertBefore(card, dom.imagesContainer.firstChild);

        try {
            let finalPrompt = rawPrompt;

            // Translate prompt if enabled
            if (dom.translateCheckbox.checked) {
                card.querySelector('span').textContent = 'Translating prompt...';
                finalPrompt = await translateText(rawPrompt, 'en');
                console.log('Translated prompt:', finalPrompt);
            }

            // For turbo model, skip enhancement but still apply style
            if (dom.modelSelect.value === 'turbo') {
                if (appState.selectedStyle && styleTemplates[appState.selectedStyle]) {
                    finalPrompt += styleTemplates[appState.selectedStyle];
                }
                card.querySelector('span').textContent = 'Generating image...';
            } else {
                // For other models, use enhancement if enabled
                if (dom.enhanceCheckbox.checked) {
                    card.querySelector('span').textContent = 'Enhancing prompt...';
                    const promptWithStyle = appState.selectedStyle && styleTemplates[appState.selectedStyle] ?
                        finalPrompt + styleTemplates[appState.selectedStyle] : finalPrompt;
                    finalPrompt = await enhancePrompt(promptWithStyle);
                } else {
                    if (appState.selectedStyle && styleTemplates[appState.selectedStyle]) {
                        finalPrompt += styleTemplates[appState.selectedStyle];
                    }
                }
                card.querySelector('span').textContent = 'Generating image...';
            }

            const model = encodeURIComponent(dom.modelSelect.value || 'flux');
            const width = Math.max(512, Math.min(2048, parseInt(dom.widthInput.value) || 1024));
            const height = Math.max(512, Math.min(2048, parseInt(dom.heightInput.value) || 1024));
            const seed = dom.randomSeedCheckbox.checked ?
                Math.floor(Math.random() * 1000000) :
                (parseInt(dom.seedInput.value) || 42);

            const encodedPrompt = encodeURIComponent(finalPrompt);
            const url = `${baseUrl}/prompt/${encodedPrompt}?model=${model}&width=${width}&height=${height}&seed=${seed}&nologo=true&safe=false`;

            const res = await fetch(url);
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error('API Error:', errorText);
                throw new Error(`API Error: ${res.status} - ${errorText}`);
            }

            const blob = await res.blob();
            const imgUrl = URL.createObjectURL(blob);

            await addWatermarkAndDisplay(card, imgUrl);

        } catch (error) {
            console.error('Generation failed:', error);
            card.innerHTML = `<div class="p-4 text-center text-red-400 text-sm">Error generating image</div>`;
        } finally {
            appState.isGenerating = false;
            dom.generateBtn.disabled = false;
        }
    }

    function showTemporaryMessage(message) {
        const temp = document.createElement('div');
        temp.className = 'image-card relative glass glass-border rounded-lg aspect-square flex items-center justify-center text-gray-400 text-sm';
        temp.innerHTML = message;
        dom.imagesContainer.insertBefore(temp, dom.imagesContainer.firstChild);
        setTimeout(() => temp.remove(), 1200);
    }

    function addWatermarkAndDisplay(card, imgUrl) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = imgUrl;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const stripHeight = Math.max(40, img.height * 0.05);
            ctx.filter = 'blur(5px)';
            ctx.drawImage(canvas, 0, canvas.height - stripHeight, canvas.width, stripHeight, 0, canvas.height - stripHeight, canvas.width, stripHeight);
            ctx.filter = 'none';

            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, canvas.height - stripHeight, canvas.width, stripHeight);

            ctx.font = `${Math.max(20, img.width * 0.02)}px Orbitron`;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Exclusive ☬SHΞN™ Made', canvas.width / 2, canvas.height - stripHeight / 2);

            const label = document.createElement('div');
            label.className = 'vertical-label';
            label.innerHTML = `<a href="https://t.me/shervini" target="_blank" rel="noopener">  </a>`;

            card.innerHTML = '';
            canvas.className = 'w-full h-full object-cover rounded-lg';
            card.appendChild(canvas);
            card.appendChild(label);

            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'absolute top-2 right-2 bg-purple-600/50 text-white p-2 rounded-full hover:bg-purple-600 transition-colors backdrop-blur-sm';
            downloadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>';
            downloadBtn.title = 'Download Image';
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                canvas.toBlob((canvasBlob) => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(canvasBlob);
                    a.download = `shenerator_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
            });
            card.appendChild(downloadBtn);

            URL.revokeObjectURL(imgUrl);
        
        };
        img.onerror = () => {
             card.innerHTML = `<div class="p-4 text-center text-red-400 text-sm">Failed to load image.</div>`;
             URL.revokeObjectURL(imgUrl);
        }
    }

    function setupStyleRoller() {
        const roller = dom.styleRoller;
        if (!roller) return;

        const itemHeight = 40;
        const viewportHeight = roller.clientHeight;
        const paddingTop = (viewportHeight / 2) - (itemHeight / 2);

        roller.innerHTML = '';
        roller.style.paddingTop = `${paddingTop}px`;
        roller.style.paddingBottom = `${paddingTop}px`;

        const displayStyles = [...styles, ...styles, ...styles];

        displayStyles.forEach(style => {
            const item = document.createElement('div');
            item.className = 'style-item h-10 flex items-center justify-center text-lg font-semibold snap-center';
            item.textContent = style.name;
            item.dataset.data = style.data;
            roller.appendChild(item);
        });

        const oneBlockHeight = styles.length * itemHeight;
        // Use saved style selection for initial position
        const defaultIndex = styles.findIndex(s => s.data === appState.savedStyleSelection);
        const initialScrollTop = oneBlockHeight + (defaultIndex >= 0 ? defaultIndex * itemHeight : 0);

        roller.scrollTop = initialScrollTop;

        let scrollTimeout;
        roller.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);

            const scrollTop = roller.scrollTop;
            if (scrollTop >= oneBlockHeight * 2) {
                roller.scrollTop = scrollTop - oneBlockHeight;
            } else if (scrollTop < oneBlockHeight) {
                roller.scrollTop = scrollTop + oneBlockHeight;
            }

            const allItems = roller.querySelectorAll('.style-item');
            const centerLine = roller.scrollTop + (viewportHeight / 2);

            allItems.forEach(item => {
                const itemTop = item.offsetTop;
                const itemCenter = itemTop + (itemHeight / 2);
                if (Math.abs(itemCenter - centerLine) < itemHeight / 2) {
                    item.classList.add('is-active');
                } else {
                    item.classList.remove('is-active');
                }
            });

            scrollTimeout = setTimeout(() => {
                const finalScrollTop = roller.scrollTop;
                const rawIndex = Math.round((finalScrollTop - paddingTop) / itemHeight);
                const activeIndex = ((rawIndex % styles.length) + styles.length) % styles.length;

                if (styles[activeIndex]) {
                    // Update temporary selection while browsing
                    appState.tempStyleSelection = styles[activeIndex].data;
                }
            }, 150);
        });

        roller.dispatchEvent(new Event('scroll'));
    }

    // --- Speech to Text ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    if (recognition) {
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'fa-IR';

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            dom.promptInput.value += transcript + ' ';
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            dom.micBtn.classList.remove('recording');
        };

        recognition.onend = () => {
            dom.micBtn.classList.remove('recording');
        };

        dom.micBtn.addEventListener('click', () => {
            if (dom.micBtn.classList.contains('recording')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    dom.micBtn.classList.add('recording');
                } catch(e) {
                    console.error("Recognition start failed:", e);
                    dom.micBtn.classList.remove('recording');
                }
            }
        });
    } else {
        dom.micBtn.style.display = 'none';
    }

    // --- Event Listeners ---
    dom.generateBtn.addEventListener('click', generateImage);
    dom.promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            generateImage();
        }
    });
    dom.styleBtn.addEventListener('click', () => {
        // Reset temp selection to current saved selection when opening modal
        appState.tempStyleSelection = appState.savedStyleSelection;
        toggleModal(dom.styleModal);
        setupStyleRoller();
    });
    dom.settingsBtn.addEventListener('click', () => toggleModal(dom.settingsModal));
    
    // FIXED: Save Style Button
    dom.saveStyleBtn.addEventListener('click', () => {
        // Save the temporary selection as the actual selection
        appState.selectedStyle = appState.tempStyleSelection;
        appState.savedStyleSelection = appState.tempStyleSelection;
        saveSettings();
        toggleModal(null);
    });
    
    // FIXED: Close Style Button (without saving)
    dom.closeStyleBtn.addEventListener('click', () => {
        // Revert to saved selection without saving temp selection
        appState.tempStyleSelection = appState.savedStyleSelection;
        toggleModal(null);
    });
    
    dom.saveSettingsBtn.addEventListener('click', () => {
        saveSettings();
        toggleModal(null);
    });

    dom.styleModal.addEventListener('click', (e) => {
        if (e.target === dom.styleModal) {
            // Revert to saved selection when clicking outside
            appState.tempStyleSelection = appState.savedStyleSelection;
            toggleModal(null);
        }
    });
    dom.settingsModal.addEventListener('click', (e) => {
        if (e.target === dom.settingsModal) toggleModal(null);
    });

    dom.randomSeedCheckbox.addEventListener('change', (e) => {
        dom.seedInput.disabled = e.target.checked;
    });

    // --- Model Selection & Age Gate Logic ---
    let previousModelValue = dom.modelSelect.value;

    dom.modelSelect.addEventListener('change', (e) => {
        const newModelValue = e.target.value;
        if (newModelValue === 'turbo') {
            dom.ageModal.classList.remove('hidden');
            dom.ageModal.classList.add('flex');
        } else {
            previousModelValue = newModelValue;
        }
    });

    dom.ageConfirm.addEventListener('click', () => {
        previousModelValue = 'turbo';
        dom.ageModal.classList.add('hidden');
        dom.ageModal.classList.remove('flex');
    });

    dom.ageCancel.addEventListener('click', () => {
        dom.modelSelect.value = previousModelValue;
        dom.ageModal.classList.add('hidden');
        dom.ageModal.classList.remove('flex');
    });

    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        previousModelValue = dom.modelSelect.value;
    });
</script>

</body>
</html>
